parameters:
  - name: command
    type: string
    default: 'build'
    values:
    - build
    - push
  - name: repository
    type: string
  - name: dockerfile
    type: string
  - name: containerRegistry
    type: string
  - name: container_sources
    type: object

steps:
  - task: Docker@2
    displayName: acr_login
    inputs:
      command: login
      containerRegistry: ${{ parameters.containerRegistry }}
  - ${{ each src in parameters.container_sources }}:
    - task: Docker@2
      displayName: docker_build_${{ src }}
      inputs:
        command: build
        dockerfile: ${{ parameters.dockerfile }}
        repository: ${{ src }}
        arguments: "--build-arg SRC=${{ src }}"
        tags: |
          $(Build.BuildId)
    - ${{ if eq(parameters.command,'push') }}:
      - task: Docker@2
        displayName: acr_push_${{ src }}
        inputs:
          command: push
          repository: ${{ src }}
          containerRegistry: ${{ parameters.containerRegistry }}
          tags: |
            $(Build.BuildId)
